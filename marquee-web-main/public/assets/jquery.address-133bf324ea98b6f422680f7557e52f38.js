/*
 * jQuery Address Plugin v${version}
 * http://www.asual.com/jquery/address/
 *
 * Copyright (c) 2009-2010 Rostislav Hristov
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Date: ${timestamp}
 */
!function(t){t.address=function(){var e,s,i=function(e){t(t.address).trigger(t.extend(t.Event(e),function(){for(var e={},s=t.address.parameterNames(),i=0,r=s.length;r>i;i++)e[s[i]]=t.address.parameter(s[i]);return{value:t.address.value(),path:t.address.path(),pathNames:t.address.pathNames(),parameterNames:s,parameters:e,queryString:t.address.queryString()}}.call(t.address)))},r=function(t){return Array.prototype.slice.call(t)},n=function(){return t().bind.apply(t(t.address),Array.prototype.slice.call(arguments)),t.address},h=function(){return W.pushState&&R.state!==e},a=function(){return("/"+L.pathname.replace(new RegExp(R.state),"")+L.search+(l()?"#"+l():"")).replace(K,"/")},l=function(){var t=L.href.indexOf("#");return-1!=t?_(L.href.substr(t+1),$):""},o=function(){return h()?a():l()},c=function(){try{return top.document!==e?top:window}catch(t){return window}},u=function(){return"javascript"},d=function(t){return t=t.toString(),(R.strict&&"/"!=t.substr(0,1)?"/":"")+t},_=function(t,e){return R.crawlable&&e?(""!==t?"!":"")+t:t.replace(/^\!/,"")},p=function(t,e){return parseInt(t.css(e),10)},f=function(){if(!X){var t=o(),e=se!=t;e&&(P&&7>I?L.reload():(P&&!Q&&R.history&&F(v,50),se=t,g($)))}},g=function(t){i(O),i(t?S:E),F(m,10)},m=function(){if("null"!==R.tracker&&null!==R.tracker){var s=t.isFunction(R.tracker)?R.tracker:M[R.tracker],i=(L.pathname+L.search+(t.address&&!h()?t.address.value():"")).replace(/\/\//,"/").replace(/^\/$/,"");t.isFunction(s)?s(i):t.isFunction(M.urchinTracker)?M.urchinTracker(i):M.pageTracker!==e&&t.isFunction(M.pageTracker._trackPageview)?M.pageTracker._trackPageview(i):M._gaq!==e&&t.isFunction(M._gaq.push)&&M._gaq.push(["_trackPageview",decodeURI(i)])}},v=function(){var t=u()+":"+$+";document.open();document.writeln('<html><head><title>"+D.title.replace(/\'/g,"\\'")+"</title><script>var "+z+' = "'+o()+(D.domain!=L.hostname?'";document.domain="'+D.domain:"")+"\";</script></head></html>');document.close();";7>I?s.src=t:s.contentWindow.location.replace(t)},y=function(){if(G&&-1!=J){var t,e,s=G.substr(J+1).split("&");for(t=0;t<s.length;t++)e=s[t].split("="),/^(autoUpdate|crawlable|history|strict|wrap)$/.test(e[0])&&(R[e[0]]=isNaN(e[1])?/^(true|yes)$/i.test(e[1]):0!==parseInt(e[1],10)),/^(state|tracker)$/.test(e[0])&&(R[e[0]]=e[1]);G=null}se=o()},b=function(){if(!Z){Z=N,y();var r=function(){w.call(this),C.call(this)},n=t("body").ajaxComplete(r);if(r(),R.wrap){{t("body > *").wrapAll('<div style="padding:'+(p(n,"marginTop")+p(n,"paddingTop"))+"px "+(p(n,"marginRight")+p(n,"paddingRight"))+"px "+(p(n,"marginBottom")+p(n,"paddingBottom"))+"px "+(p(n,"marginLeft")+p(n,"paddingLeft"))+'px;" />').parent().wrap('<div id="'+z+'" style="height:100%;overflow:auto;position:relative;'+(U&&!window.statusbar.visible?"resize:both;":"")+'" />')}t("html, body").css({height:"100%",margin:0,padding:0,overflow:"hidden"}),U&&t('<style type="text/css" />').appendTo("head").text("#"+z+"::-webkit-resizer { background-color: #fff; }")}if(P&&!Q){var a=D.getElementsByTagName("frameset")[0];s=D.createElement((a?"":"i")+"frame"),s.src=u()+":"+$,a?(a.insertAdjacentElement("beforeEnd",s),a[a.cols?"cols":"rows"]+=",0",s.noResize=N,s.frameBorder=s.frameSpacing=0):(s.style.display="none",s.style.width=s.style.height=0,s.tabIndex=-1,D.body.insertAdjacentElement("afterBegin",s)),F(function(){t(s).bind("load",function(){var t=s.contentWindow;se=t[z]!==e?t[z]:"",se!=o()&&(g($),L.hash=_(se,N))}),s.contentWindow[z]===e&&v()},50)}F(function(){i("init"),g($)},1),h()||(Q?M.addEventListener?M.addEventListener(q,f,$):M.attachEvent&&M.attachEvent("on"+q,f):B(f,50))}},w=function(){var e,s=t("a"),i=s.size(),r=1,n=-1,h='[rel*="address:"]',a=function(){++n!=i&&(e=t(s.get(n)),e.is(h)&&e.address(h),F(a,r))};F(a,r)},x=function(){se!=o()&&(se=o(),g($))},k=function(){M.removeEventListener?M.removeEventListener(q,f,$):M.detachEvent&&M.detachEvent("on"+q,f)},C=function(){if(R.crawlable){var e=L.pathname.replace(/\/$/,""),s="_escaped_fragment_";-1!=t("body").html().indexOf(s)&&t('a[href]:not([href^=http]), a[href*="'+document.domain+'"]').each(function(){var i=t(this).attr("href").replace(/^http:/,"").replace(new RegExp(e+"/?$"),"");(""===i||-1!=i.indexOf(s))&&t(this).attr("href","#"+encodeURI(decodeURIComponent(i.replace(new RegExp("/(.*)\\?"+s+"=(.*)$"))),"!$2"))})}},z="jQueryAddress",j="string",q="hashchange",T="init",O="change",S="internalChange",E="externalChange",N=!0,$=!1,R={autoUpdate:N,crawlable:$,history:N,strict:N,wrap:$},A=t.browser,I=parseFloat(A.version),P=!t.support.opacity,U=A.webkit||A.safari,M=c(),D=M.document,W=M.history,L=M.location,B=setInterval,F=setTimeout,K=/\/{2,9}/g,H=navigator.userAgent,Q="on"+q in M,G=t("script:last").attr("src"),J=G?G.indexOf("?"):-1,V=D.title,X=$,Z=$,Y=N,te=N,ee=$,se=o();if(P){I=parseFloat(H.substr(H.indexOf("MSIE")+4)),D.documentMode&&D.documentMode!=I&&(I=8!=D.documentMode?7:8);var ie=D.onpropertychange;D.onpropertychange=function(){ie&&ie.call(D),D.title!=V&&-1!=D.title.indexOf("#"+o())&&(D.title=V)}}if(W.navigationMode&&(W.navigationMode="compatible"),"complete"==document.readyState)var re=setInterval(function(){t.address&&(b(),clearInterval(re))},50);else y(),t(b);return t(window).bind("popstate",x).bind("unload",k),{bind:function(){return n.apply(this,r(arguments))},init:function(){return n.apply(this,[T].concat(r(arguments)))},change:function(){return n.apply(this,[O].concat(r(arguments)))},internalChange:function(){return n.apply(this,[S].concat(r(arguments)))},externalChange:function(){return n.apply(this,[E].concat(r(arguments)))},baseURL:function(){var t=L.href;return-1!=t.indexOf("#")&&(t=t.substr(0,t.indexOf("#"))),/\/$/.test(t)&&(t=t.substr(0,t.length-1)),t},autoUpdate:function(t){return t!==e?(R.autoUpdate=t,this):R.autoUpdate},crawlable:function(t){return t!==e?(R.crawlable=t,this):R.crawlable},history:function(t){return t!==e?(R.history=t,this):R.history},state:function(t){if(t!==e){R.state=t;var s=a();return R.state!==e&&(W.pushState?"/#/"==s.substr(0,3)&&L.replace(R.state.replace(/^\/$/,"")+s.substr(2)):"/"!=s&&s.replace(/^\/#/,"")!=l()&&F(function(){L.replace(R.state.replace(/^\/$/,"")+"/#"+s)},1)),this}return R.state},strict:function(t){return t!==e?(R.strict=t,this):R.strict},tracker:function(t){return t!==e?(R.tracker=t,this):R.tracker},wrap:function(t){return t!==e?(R.wrap=t,this):R.wrap},update:function(){return ee=N,this.value(se),ee=$,this},title:function(t){return t!==e?(F(function(){V=D.title=t,te&&s&&s.contentWindow&&s.contentWindow.document&&(s.contentWindow.document.title=t,te=$),!Y&&A.mozilla&&L.replace(-1!=L.href.indexOf("#")?L.href:L.href+"#"),Y=$},50),this):D.title},value:function(t){if(t!==e){if(t=d(t),"/"==t&&(t=""),se==t&&!ee)return;return Y=N,se=t,(R.autoUpdate||ee)&&(g(N),h()?W[R.history?"pushState":"replaceState"]({},"",R.state.replace(/\/$/,"")+(""===se?"/":se)):(X=N,U?R.history?L.hash="#"+_(se,N):L.replace("#"+_(se,N)):se!=o()&&(R.history?L.hash="#"+_(se,N):L.replace("#"+_(se,N))),P&&!Q&&R.history&&F(v,50),U?F(function(){X=$},1):X=$)),this}return d(se)},path:function(t){if(t!==e){var s=this.queryString(),i=this.hash();return this.value(t+(s?"?"+s:"")+(i?"#"+i:"")),this}return d(se).split("#")[0].split("?")[0]},pathNames:function(){var t=this.path(),e=t.replace(K,"/").split("/");return("/"==t.substr(0,1)||0===t.length)&&e.splice(0,1),"/"==t.substr(t.length-1,1)&&e.splice(e.length-1,1),e},queryString:function(t){if(t!==e){var s=this.hash();return this.value(this.path()+(t?"?"+t:"")+(s?"#"+s:"")),this}var i=se.split("?");return i.slice(1,i.length).join("?").split("#")[0]},parameter:function(s,i,r){var n,h;if(i!==e){var a=this.parameterNames();for(h=[],i=i?i.toString():"",n=0;n<a.length;n++){var l=a[n],o=this.parameter(l);typeof o==j&&(o=[o]),l==s&&(o=null===i||""===i?[]:r?o.concat([i]):[i]);for(var c=0;c<o.length;c++)h.push(l+"="+o[c])}return-1==t.inArray(s,a)&&null!==i&&""!==i&&h.push(s+"="+i),this.queryString(h.join("&")),this}if(i=this.queryString()){var u=[];for(h=i.split("&"),n=0;n<h.length;n++){var d=h[n].split("=");d[0]==s&&u.push(d.slice(1).join("="))}if(0!==u.length)return 1!=u.length?u:u[0]}},parameterNames:function(){var e=this.queryString(),s=[];if(e&&-1!=e.indexOf("="))for(var i=e.split("&"),r=0;r<i.length;r++){var n=i[r].split("=")[0];-1==t.inArray(n,s)&&s.push(n)}return s},hash:function(t){if(t!==e)return this.value(se.split("#")[0]+(t?"#"+t:"")),this;var s=se.split("#");return s.slice(1,s.length).join("#")}}}(),t.fn.address=function(e){var s;if("string"==typeof e&&(s=e,e=void 0),!t(this).attr("address")){var i=function(s){if(s.shiftKey||s.ctrlKey||s.metaKey||2==s.which)return!0;if(t(this).is("a")){s.preventDefault();var i=e?e.call(this):/address:/.test(t(this).attr("rel"))?t(this).attr("rel").split("address:")[1].split(" ")[0]:void 0===t.address.state()||/^\/?$/.test(t.address.state())?t(this).attr("href").replace(/^(#\!?|\.)/,""):t(this).attr("href").replace(new RegExp("^(.*"+t.address.state()+"|\\.)"),"");t.address.value(i)}};t(s?s:this).live("click",i).live("submit",function(s){if(t(this).is("form")){s.preventDefault();var i=t(this).attr("action"),r=e?e.call(this):(-1!=i.indexOf("?")?i.replace(/&$/,""):i+"?")+t(this).serialize();t.address.value(r)}}).attr("address",!0)}return this}}(jQuery);